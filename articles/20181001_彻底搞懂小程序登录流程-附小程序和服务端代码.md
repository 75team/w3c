# å½»åº•ææ‡‚å°ç¨‹åºç™»å½•æµç¨‹-é™„å°ç¨‹åºå’ŒæœåŠ¡ç«¯ä»£ç 

ç”¨æˆ·ç™»å½•æ˜¯å¤§éƒ¨åˆ†å®Œæ•´ App å¿…å¤‡çš„æµç¨‹

ä¸€ä¸ªç®€å•çš„ç”¨æˆ·ç³»ç»Ÿéœ€è¦å…³æ³¨è‡³å°‘è¿™äº›å±‚é¢

- å®‰å…¨æ€§(åŠ å¯†)
- æŒä¹…åŒ–ç™»å½•æ€(ç±»ä¼¼cookie)
- ç™»å½•è¿‡æœŸå¤„ç†
- ç¡®ä¿ç”¨æˆ·å”¯ä¸€æ€§, é¿å…å‡ºç°å¤šè´¦å·
- æˆæƒ
- ç»‘å®šç”¨æˆ·æ˜µç§°å¤´åƒç­‰ä¿¡æ¯
- ç»‘å®šæ‰‹æœºå·(å®åå’Œå¯†ä¿æ–¹å¼)

å¾ˆå¤šçš„ä¸šåŠ¡éœ€æ±‚éƒ½å¯ä»¥æŠ½è±¡æˆ Restful æ¥å£é…åˆ CRUD æ“ä½œ

ä½†ç™»å½•æµç¨‹å´æ˜¯é”™ç»¼å¤æ‚, å„ä¸ªå¹³å°æœ‰å„è‡ªçš„æµç¨‹, åå€’æˆäº†é¡¹ç›®ä¸­è´¹æ—¶é—´çš„éƒ¨åˆ†, æ¯”å¦‚å°ç¨‹åºçš„ç™»å½•æµç¨‹

![](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/image/api-login.jpg?t=18091415)

å¯¹äºä¸€ä¸ªä»é›¶å¼€å§‹çš„é¡¹ç›®æ¥è¯´, æå®šç™»å½•æµç¨‹, å°±æ˜¯ä¸€ä¸ªå¥½çš„å¼€å§‹, ä¸€ä¸ªå¥½çš„å¼€å§‹, å°±æ˜¯æˆåŠŸçš„ä¸€åŠ

æœ¬æ–‡å°±ä»¥å¾®ä¿¡å°ç¨‹åºè¿™ä¸ªå¹³å°, è®²è¿°ä¸€ä¸ªå®Œæ•´çš„è‡ªå®šä¹‰ç”¨æˆ·ç™»å½•æµç¨‹, ä¸€èµ·æ¥å•ƒè¿™å—éš¾å•ƒçš„éª¨å¤´


## åè¯è§£é‡Š

å…ˆç»™ç™»å½•æµç¨‹æ—¶åºå›¾ä¸­å‡ºç°çš„åè¯ç®€å•åšä¸€ä¸ªè§£é‡Š

- `code` ä¸´æ—¶ç™»å½•å‡­è¯, æœ‰æ•ˆæœŸäº”åˆ†é’Ÿ, é€šè¿‡ `wx.login()` è·å–
- `session_key` ä¼šè¯å¯†é’¥, æœåŠ¡ç«¯é€šè¿‡ [code2Session](https://developers.weixin.qq.com/miniprogram/dev/api/open-api/login/code2Session.html) è·å–
- `openId` ç”¨æˆ·åœ¨è¯¥å°ç¨‹åºä¸‹çš„ç”¨æˆ·å”¯ä¸€æ ‡è¯†, æ°¸è¿œä¸å˜, æœåŠ¡ç«¯é€šè¿‡ code è·å–
- `unionId` ç”¨æˆ·åœ¨åŒä¸€ä¸ªå¾®ä¿¡å¼€æ”¾å¹³å°å¸å·(å…¬ä¼—å·, å°ç¨‹åº, ç½‘ç«™, ç§»åŠ¨åº”ç”¨)ä¸‹çš„å”¯ä¸€æ ‡è¯†, æ°¸è¿œä¸å˜
- `appId` å°ç¨‹åºå”¯ä¸€æ ‡è¯†
- `appSecret` å°ç¨‹åºçš„ app secret, å¯ä»¥å’Œ code, appId ä¸€èµ·æ¢å– session_key

### å…¶ä»–åè¯

- `rawData` ä¸åŒ…æ‹¬æ•æ„Ÿä¿¡æ¯çš„åŸå§‹æ•°æ®å­—ç¬¦ä¸²ï¼Œç”¨äºè®¡ç®—ç­¾å
- `encryptedData` åŒ…å«æ•æ„Ÿä¿¡æ¯çš„ç”¨æˆ·ä¿¡æ¯, æ˜¯åŠ å¯†çš„
- `signature` ç”¨äºæ ¡éªŒç”¨æˆ·ä¿¡æ¯æ˜¯å¦æ— ç¯¡æ”¹
- `iv` åŠ å¯†ç®—æ³•çš„åˆå§‹å‘é‡

> å“ªäº›ä¿¡æ¯æ˜¯æ•æ„Ÿä¿¡æ¯å‘¢? æ‰‹æœºå·, openId, unionId, å¯ä»¥çœ‹å‡ºè¿™äº›å€¼éƒ½å¯ä»¥å”¯ä¸€å®šä½ä¸€ä¸ªç”¨æˆ·, è€Œæ˜µç§°, å¤´åƒè¿™äº›ä¸èƒ½å®šä½ç”¨æˆ·çš„éƒ½ä¸æ˜¯æ•æ„Ÿä¿¡æ¯

## å°ç¨‹åºç™»å½•ç›¸å…³å‡½æ•°

- `wx.login`
- `wx.getUserInfo`
- `wx.checkSession`

## å°ç¨‹åºçš„ promise

æˆ‘ä»¬å‘ç°å°ç¨‹åºçš„å¼‚æ­¥æ¥å£éƒ½æ˜¯ success å’Œ fail çš„å›è°ƒ, å¾ˆå®¹æ˜“å†™å‡º**å›è°ƒåœ°ç‹±**

å› æ­¤å¯ä»¥å…ˆç®€å•å®ç°ä¸€ä¸ª wx å¼‚æ­¥å‡½æ•°è½¬æˆ promise çš„å·¥å…·å‡½æ•°

```js
const promisify = original => {
  return function(opt) {
    return new Promise((resolve, reject) => {
      opt = Object.assign({
        success: resolve,
        fail: reject
      }, opt)
      original(opt)
    })
  }
}
```

è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥è¿™æ ·è°ƒç”¨å‡½æ•°äº†

```js
promisify(wx.getStorage)({key: 'key'}).then(value => {
  // success
}).catch(reason => {
  // fail
})
```

## æœåŠ¡ç«¯å®ç°

æœ¬ demo çš„æœåŠ¡ç«¯å®ç°åŸºäº express.js

> æ³¨æ„, ä¸ºäº† demo çš„ç®€æ´æ€§, æœåŠ¡ç«¯ä½¿ç”¨ js å˜é‡æ¥ä¿å­˜ç”¨æˆ·æ•°æ®, ä¹Ÿå°±æ˜¯è¯´å¦‚æœé‡å¯æœåŠ¡ç«¯, ç”¨æˆ·æ•°æ®å°±æ¸…ç©ºäº†

> å¦‚éœ€æŒä¹…åŒ–å­˜å‚¨ç”¨æˆ·æ•°æ®, å¯ä»¥è‡ªè¡Œå®ç°æ•°æ®åº“ç›¸å…³é€»è¾‘

```js
// å­˜å‚¨æ‰€æœ‰ç”¨æˆ·ä¿¡æ¯
const users = {
  // openId ä½œä¸ºç´¢å¼•
  openId: {
    // æ•°æ®ç»“æ„å¦‚ä¸‹
    openId: '', // ç†è®ºä¸Šä¸åº”è¯¥è¿”å›ç»™å‰ç«¯
    sessionKey: '',
    nickName: '',
    avatarUrl: '',
    unionId: '',
    phoneNumber: ''
  }
}

app
  .use(bodyParser.json())
  .use(session({
    secret: 'alittlegirl',
    resave: false,
    saveUninitialized: true
  }))
```


## å°ç¨‹åºç™»å½•

æˆ‘ä»¬å…ˆå®ç°ä¸€ä¸ªåŸºæœ¬çš„ oauth æˆæƒç™»å½•

> oauth æˆæƒç™»å½•ä¸»è¦æ˜¯ code æ¢å– openId å’Œ sessionKey çš„è¿‡ç¨‹

### å‰ç«¯å°ç¨‹åºç™»å½•

å†™åœ¨ app.js ä¸­

```js
login () {
  console.log('ç™»å½•')
  return util.promisify(wx.login)().then(({code}) => {
    console.log(`code: ${code}`)
    return http.post('/oauth/login', {
      code,
      type: 'wxapp'
    })
  })
}
```

### æœåŠ¡ç«¯å®ç° oauth æˆæƒ

æœåŠ¡ç«¯å®ç°ä¸Šè¿° `/oauth/login` è¿™ä¸ªæ¥å£

```js
app
  .post('/oauth/login', (req, res) => {
    var params = req.body
    var {code, type} = params
    if (type === 'wxapp') {
      // code æ¢å– openId å’Œ sessionKey çš„ä¸»è¦é€»è¾‘
      axios.get('https://api.weixin.qq.com/sns/jscode2session', {
        params: {
          appid: config.appId,
          secret: config.appSecret,
          js_code: code,
          grant_type: 'authorization_code'
        }
      }).then(({data}) => {
        var openId = data.openid
        var user = users[openId]
        if (!user) {
          user = {
            openId,
            sessionKey: data.session_key
          }
          users[openId] = user
          console.log('æ–°ç”¨æˆ·', user)
        } else {
          console.log('è€ç”¨æˆ·', user)
        }
        req.session.openId = user.openId
        req.user = user
      }).then(() => {
        res.send({
          code: 0
        })
      })
    } else {
      throw new Error('æœªçŸ¥çš„æˆæƒç±»å‹')
    }
  })
```

## è·å–ç”¨æˆ·ä¿¡æ¯

ç™»å½•ç³»ç»Ÿä¸­éƒ½ä¼šæœ‰ä¸€ä¸ªé‡è¦çš„åŠŸèƒ½: è·å–ç”¨æˆ·ä¿¡æ¯, æˆ‘ä»¬ç§°ä¹‹ä¸º `getUserInfo`

å¦‚æœå·²ç™»å½•ç”¨æˆ·è°ƒç”¨ getUserInfo åˆ™è¿”å›ç”¨æˆ·ä¿¡æ¯, æ¯”å¦‚æ˜µç§°, å¤´åƒç­‰, å¦‚æœæœªç™»å½•åˆ™è¿”å›"ç”¨æˆ·æœªç™»å½•"

> ä¹Ÿå°±æ˜¯è¯´æ­¤æ¥å£è¿˜æœ‰**åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ç™»å½•**çš„åŠŸæ•ˆ...

å°ç¨‹åºçš„ç”¨æˆ·ä¿¡æ¯ä¸€èˆ¬å­˜å‚¨åœ¨ `app.globalData.userInfo` ä¸­(æ¨¡æ¿å¦‚æ­¤)

æˆ‘ä»¬åœ¨æœåŠ¡ç«¯åŠ ä¸Šå‰ç½®ä¸­é—´ä»¶, é€šè¿‡ session æ¥è·å–å¯¹åº”çš„ç”¨æˆ·ä¿¡æ¯, å¹¶æ”¾åœ¨ req å¯¹è±¡ä¸­

```js
app
  .use((req, res, next) => {
    req.user = users[req.session.openId]
    next()
  })
```

ç„¶åå®ç° `/user/info` æ¥å£, ç”¨æ¥è¿”å›ç”¨æˆ·ä¿¡æ¯

```js
app
  .get('/user/info', (req, res) => {
    if (req.user) {
      return res.send({
        code: 0,
        data: req.user
      })
    }
    throw new Error('ç”¨æˆ·æœªç™»å½•')
  })
```

å°ç¨‹åºè°ƒç”¨ç”¨æˆ·ä¿¡æ¯æ¥å£

```js
getUserInfo () {
  return http.get('/user/info').then(response => {
    let data = response.data
    if (data && typeof data === 'object') {
      // è·å–ç”¨æˆ·ä¿¡æ¯æˆåŠŸåˆ™ä¿å­˜åˆ°å…¨å±€
      this.globalData.userInfo = data
      return data
    }
    return Promise.reject(response)
  })
}
```

## ä¸“ä¸ºå°ç¨‹åºå‘è¯·æ±‚è®¾è®¡çš„åº“

å°ç¨‹åºä»£ç é€šè¿‡ `http.get`, `http.post` è¿™æ ·çš„ api æ¥å‘è¯·æ±‚, èƒŒåä½¿ç”¨äº†ä¸€ä¸ªè¯·æ±‚åº“

[@chunpu/http](https://github.com/chunpu/http) æ˜¯ä¸€ä¸ªä¸“é—¨ä¸ºå°ç¨‹åºè®¾è®¡çš„ http è¯·æ±‚åº“, å¯ä»¥åœ¨å°ç¨‹åºä¸Šåƒ axios ä¸€æ ·å‘è¯·æ±‚, æ”¯æŒæ‹¦æˆªå™¨ç­‰å¼ºå¤§åŠŸèƒ½, ç”šè‡³æ¯” axios æ›´é¡ºæ‰‹

åˆå§‹åŒ–æ–¹æ³•å¦‚ä¸‹

```js
import http from '@chunpu/http'

http.init({
  baseURL: 'http://localhost:9999', // å®šä¹‰ baseURL, ç”¨äºæœ¬åœ°æµ‹è¯•
  wx // æ ‡è®°æ˜¯å¾®ä¿¡å°ç¨‹åºç”¨
})
```

å…·ä½“ä½¿ç”¨æ–¹æ³•å¯å‚ç…§æ–‡æ¡£ <https://github.com/chunpu/http#readme>


## è‡ªå®šä¹‰ç™»å½•æ€æŒä¹…åŒ–

æµè§ˆå™¨æœ‰ cookie, ç„¶è€Œå°ç¨‹åºæ²¡æœ‰ cookie, é‚£æ€ä¹ˆæ¨¡ä»¿å‡ºåƒç½‘é¡µè¿™æ ·çš„ç™»å½•æ€å‘¢?

è¿™é‡Œè¦ç”¨åˆ°å°ç¨‹åºè‡ªå·±çš„**æŒä¹…åŒ–**æ¥å£, ä¹Ÿå°±æ˜¯ setStorage å’Œ getStorage

ä¸ºäº†æ–¹ä¾¿å„ç«¯å…±ç”¨æ¥å£, æˆ–è€…ç›´æ¥å¤ç”¨ web æ¥å£, æˆ‘ä»¬è‡ªè¡Œå®ç°ä¸€ä¸ªç®€å•çš„è¯» cookie å’Œç§ cookie çš„é€»è¾‘

å…ˆæ˜¯è¦æ ¹ä¾æ®è¿”å›çš„ http response headers æ¥**ç§ä¸Š cookie**, æ­¤å¤„æˆ‘ä»¬ç”¨åˆ°äº† `@chunpu/http` ä¸­çš„ response æ‹¦æˆªå™¨, å’Œ axios ç”¨æ³•ä¸€æ ·

```js
http.interceptors.response.use(response => {
  // ç§ cookie
  var {headers} = response
  var cookies = headers['set-cookie'] || ''
  cookies = cookies.split(/, */).reduce((prev, item) => {
    item = item.split(/; */)[0]
    var obj = http.qs.parse(item)
    return Object.assign(prev, obj)
  }, {})
  if (cookies) {
    return util.promisify(wx.getStorage)({
      key: 'cookie'
    }).catch(() => {}).then(res => {
      res = res || {}
      var allCookies = res.data || {}
      Object.assign(allCookies, cookies)
      return util.promisify(wx.setStorage)({
        key: 'cookie',
        data: allCookies
      })
    }).then(() => {
      return response
    })
  }
  return response
})
```

å½“ç„¶æˆ‘ä»¬è¿˜éœ€è¦åœ¨å‘è¯·æ±‚çš„æ—¶å€™**å¸¦ä¸Šæ‰€æœ‰ cookie**, æ­¤å¤„ç”¨çš„æ˜¯ request æ‹¦æˆªå™¨

```js
http.interceptors.request.use(config => {
  // ç»™è¯·æ±‚å¸¦ä¸Š cookie
  return util.promisify(wx.getStorage)({
    key: 'cookie'
  }).catch(() => {}).then(res => {
    if (res && res.data) {
      Object.assign(config.headers, {
        Cookie: http.qs.stringify(res.data, ';', '=')
      })
    }
    return config
  })
})
```

### ç™»å½•æ€çš„æœ‰æ•ˆæœŸ

æˆ‘ä»¬çŸ¥é“, æµè§ˆå™¨é‡Œé¢çš„ç™»å½•æ€ cookie æ˜¯æœ‰å¤±æ•ˆæ—¶é—´çš„, æ¯”å¦‚ä¸€å¤©, ä¸ƒå¤©, æˆ–è€…ä¸€ä¸ªæœˆ

ä¹Ÿè®¸æœ‰æœ‹å‹ä¼šæå‡ºç–‘é—®, ç›´æ¥ç”¨ storage çš„è¯, å°ç¨‹åºçš„ç™»å½•æ€æœ‰æ•ˆæœŸæ€ä¹ˆåŠ?

é—®åˆ°ç‚¹ä¸Šäº†! å°ç¨‹åºå·²ç»å¸®æˆ‘ä»¬å®ç°å¥½äº† session æœ‰æ•ˆæœŸçš„åˆ¤æ–­ `wx.checkSession`

å®ƒæ¯” cookie æ›´æ™ºèƒ½, å®˜æ–¹æ–‡æ¡£æè¿°å¦‚ä¸‹

> é€šè¿‡ wx.login æ¥å£è·å¾—çš„ç”¨æˆ·ç™»å½•æ€æ‹¥æœ‰ä¸€å®šçš„æ—¶æ•ˆæ€§ã€‚ç”¨æˆ·è¶Šä¹…æœªä½¿ç”¨å°ç¨‹åºï¼Œç”¨æˆ·ç™»å½•æ€è¶Šæœ‰å¯èƒ½å¤±æ•ˆã€‚åä¹‹å¦‚æœç”¨æˆ·ä¸€ç›´åœ¨ä½¿ç”¨å°ç¨‹åºï¼Œåˆ™ç”¨æˆ·ç™»å½•æ€ä¸€ç›´ä¿æŒæœ‰æ•ˆ

ä¹Ÿå°±æ˜¯è¯´å°ç¨‹åºè¿˜ä¼šå¸®æˆ‘ä»¬**è‡ªåŠ¨ renew å’±ä»¬çš„ç™»å½•æ€**, ç®€ç›´æ˜¯äººå·¥æ™ºèƒ½ cookie, ç‚¹ä¸ªèµğŸ‘

é‚£å…·ä½“åœ¨å‰ç«¯æ€ä¹ˆæ“ä½œå‘¢? ä»£ç å†™åœ¨ app.js ä¸­

```js
onLaunch: function () {
  util.promisify(wx.checkSession)().then(() => {
    console.log('session ç”Ÿæ•ˆ')
    return this.getUserInfo()
  }).then(userInfo => {
    console.log('ç™»å½•æˆåŠŸ', userInfo)
  }).catch(err => {
    console.log('è‡ªåŠ¨ç™»å½•å¤±è´¥, é‡æ–°ç™»å½•', err)
    return this.login()
  }).catch(err => {
    console.log('æ‰‹åŠ¨ç™»å½•å¤±è´¥', err)
  })
}
```

è¦æ³¨æ„, è¿™é‡Œçš„ session ä¸ä»…æ˜¯å‰ç«¯çš„ç™»å½•æ€, ä¹Ÿæ˜¯åç«¯ session_key çš„æœ‰æ•ˆæœŸ, å‰ç«¯ç™»å½•æ€å¤±æ•ˆäº†, é‚£åç«¯ä¹Ÿå¤±æ•ˆäº†éœ€è¦æ›´æ–° session_key

> ç†è®ºä¸Šå°ç¨‹åºä¹Ÿå¯ä»¥è‡ªå®šä¹‰ç™»å½•å¤±æ•ˆæ—¶é—´ç­–ç•¥, ä½†è¿™æ ·çš„è¯æˆ‘ä»¬éœ€è¦è€ƒè™‘å¼€å‘è€…è‡ªå·±çš„å¤±æ•ˆæ—¶é—´å’Œå°ç¨‹åºæ¥å£æœåŠ¡çš„å¤±æ•ˆæ—¶é—´, è¿˜ä¸å¦‚ä¿æŒç»Ÿä¸€æ¥çš„ç®€å•

## ç¡®ä¿æ¯ä¸ª Page éƒ½èƒ½è·å–åˆ° userInfo

å¦‚æœåœ¨æ–°å»ºå°ç¨‹åºé¡¹ç›®ä¸­é€‰æ‹© **å»ºç«‹æ™®é€šå¿«é€Ÿå¯åŠ¨æ¨¡æ¿**

æˆ‘ä»¬ä¼šå¾—åˆ°ä¸€ä¸ªå¯ä»¥ç›´æ¥è¿è¡Œçš„æ¨¡æ¿

ç‚¹å¼€ä»£ç ä¸€çœ‹, å¤§éƒ¨åˆ†ä»£ç éƒ½åœ¨å¤„ç† userInfo....

![](https://p3.ssl.qhimg.com/t01fde67bd6ca3f7b1a.png)

æ³¨é‡Šé‡Œå†™ç€

> ç”±äº getUserInfo æ˜¯ç½‘ç»œè¯·æ±‚ï¼Œå¯èƒ½ä¼šåœ¨ Page.onLoad ä¹‹åæ‰è¿”å›

> æ‰€ä»¥æ­¤å¤„åŠ å…¥ callback ä»¥é˜²æ­¢è¿™ç§æƒ…å†µ

ä½†è¿™æ ·çš„æ¨¡æ¿å¹¶ä¸ç§‘å­¦, è¿™æ ·ä»…ä»…æ˜¯è€ƒè™‘äº†é¦–é¡µéœ€è¦ç”¨æˆ·ä¿¡æ¯çš„æƒ…å†µ, å¦‚æœæ‰«ç è¿›å…¥çš„é¡µé¢ä¹Ÿéœ€è¦ç”¨æˆ·ä¿¡æ¯å‘¢? è¿˜æœ‰ç›´æ¥è¿›å…¥è·³è½¬çš„æœªæ”¯ä»˜é¡µæ´»åŠ¨é¡µç­‰...

å¦‚æœæ¯ä¸ªé¡µé¢éƒ½è¿™æ ·åˆ¤æ–­ä¸€éæ˜¯å¦åŠ è½½å®Œç”¨æˆ·ä¿¡æ¯, ä»£ç æ˜¾å¾—è¿‡äºå†—ä½™

æ­¤æ—¶æˆ‘ä»¬æƒ³åˆ°äº† jQuery çš„ ready å‡½æ•° `$(function)`, åªè¦ document ready äº†, å°±å¯ä»¥ç›´æ¥æ‰§è¡Œå‡½æ•°é‡Œé¢çš„ä»£ç , å¦‚æœ document è¿˜æ²¡ ready, å°±ç­‰åˆ° ready åæ‰§è¡Œä»£ç 

**å°±è¿™ä¸ªæ€è·¯äº†!** æˆ‘ä»¬æŠŠå°ç¨‹åºçš„ App å½“æˆç½‘é¡µçš„ document

æˆ‘ä»¬çš„ç›®æ ‡æ˜¯å¯ä»¥è¿™æ ·åœ¨ Page ä¸­ä¸ä¼šå‡ºé”™çš„è·å– userInfo

```js
Page({
  data: {
    userInfo: null
  },
  onLoad: function () {
    app.ready(() => {
      this.setData({
        userInfo: app.globalData.userInfo
      })
    })
  }
})
```

æ­¤å¤„æˆ‘ä»¬ä½¿ç”¨ [min-ready](https://github.com/chunpu/min-ready) æ¥å®ç°æ­¤åŠŸèƒ½

ä»£ç å®ç°ä¾ç„¶å†™åœ¨ app.js ä¸­

```js
import Ready from 'min-ready'

const ready = Ready()

App({
  getUserInfo () {
    // è·å–ç”¨æˆ·ä¿¡æ¯ä½œä¸ºå…¨å±€æ–¹æ³•
    return http.get('/user/info').then(response => {
      let data = response.data
      if (data && typeof data === 'object') {
        this.globalData.userInfo = data
        // è·å– userInfo æˆåŠŸçš„æ—¶æœºå°±æ˜¯ app ready çš„æ—¶æœº
        ready.open()
        return data
      }
      return Promise.reject(response)
    })
  },
  ready (func) {
    // æŠŠå‡½æ•°æ”¾å…¥é˜Ÿåˆ—ä¸­
    ready.queue(func)
  }
})
```

## ç»‘å®šç”¨æˆ·ä¿¡æ¯å’Œæ‰‹æœºå·

ä»…ä»…è·å–ç”¨æˆ·çš„ openId æ˜¯è¿œè¿œä¸å¤Ÿçš„, openId åªèƒ½æ ‡è®°ç”¨æˆ·, è¿ç”¨æˆ·çš„æ˜µç§°å’Œå¤´åƒéƒ½æ‹¿ä¸åˆ°

å¦‚ä½•è·å–è¿™äº›ç”¨æˆ·ä¿¡æ¯ç„¶åå­˜åˆ°åç«¯æ•°æ®åº“ä¸­å‘¢?

æˆ‘ä»¬åœ¨æœåŠ¡ç«¯å®ç°è¿™ä¸¤ä¸ªæ¥å£, **ç»‘å®šç”¨æˆ·ä¿¡æ¯**, **ç»‘å®šç”¨æˆ·æ‰‹æœºå·**

```js
app
  .post('/user/bindinfo', (req, res) => {
    var user = req.user
    if (user) {
      var {encryptedData, iv} = req.body
      var pc = new WXBizDataCrypt(config.appId, user.sessionKey)
      var data = pc.decryptData(encryptedData, iv)
      Object.assign(user, data)
      return res.send({
        code: 0
      })
    }
    throw new Error('ç”¨æˆ·æœªç™»å½•')
  })

  .post('/user/bindphone', (req, res) => {
    var user = req.user
    if (user) {
      var {encryptedData, iv} = req.body
      var pc = new WXBizDataCrypt(config.appId, user.sessionKey)
      var data = pc.decryptData(encryptedData, iv)
      Object.assign(user, data)
      return res.send({
        code: 0
      })
    }
    throw new Error('ç”¨æˆ·æœªç™»å½•')
  })
```

å°ç¨‹åºä¸ªäººä¸­å¿ƒ wxml å®ç°å¦‚ä¸‹

```xml
<view wx:if="userInfo" class="userinfo">
  <button
    wx:if="{{!userInfo.nickName}}"
    type="primary"
    open-type="getUserInfo"
    bindgetuserinfo="bindUserInfo"> è·å–å¤´åƒæ˜µç§° </button>
  <block wx:else>
    <image class="userinfo-avatar" src="{{userInfo.avatarUrl}}" mode="cover"></image>
    <text class="userinfo-nickname">{{userInfo.nickName}}</text>
  </block>

  <button
    wx:if="{{!userInfo.phoneNumber}}"
    type="primary"
    style="margin-top: 20px;"
    open-type="getPhoneNumber"
    bindgetphonenumber="bindPhoneNumber"> ç»‘å®šæ‰‹æœºå· </button>
  <text wx:else>{{userInfo.phoneNumber}}</text>
</view>
```

å°ç¨‹åºä¸­çš„ bindUserInfo å’Œ bindPhoneNumber å‡½æ•°, æ ¹æ®å¾®ä¿¡æœ€æ–°çš„ç­–ç•¥, è¿™ä¿©æ“ä½œéƒ½éœ€è¦ç”¨æˆ·ç‚¹å‡»æŒ‰é’®ç»Ÿä¸€æˆæƒæ‰èƒ½è§¦å‘

```js
bindUserInfo (e) {
  var detail = e.detail
  if (detail.iv) {
    http.post('/user/bindinfo', {
      encryptedData: detail.encryptedData,
      iv: detail.iv,
      signature: detail.signature
    }).then(() => {
      return app.getUserInfo().then(userInfo => {
        this.setData({
          userInfo: userInfo
        })
      })
    })
  }
},
bindPhoneNumber (e) {
  var detail = e.detail
  if (detail.iv) {
    http.post('/user/bindphone', {
      encryptedData: detail.encryptedData,
      iv: detail.iv
    }).then(() => {
      return app.getUserInfo().then(userInfo => {
        this.setData({
          userInfo: userInfo
        })
      })
    })
  }
}
```

## ä»£ç 

æœ¬æ–‡æ‰€æåˆ°çš„ä»£ç éƒ½å¯ä»¥åœ¨æˆ‘çš„ github ä¸Šæ‰¾åˆ°

å°ç¨‹åºä»£ç åœ¨ [wxapp-login-demo](https://github.com/chunpu/wxapp-login-demo)

æœåŠ¡ç«¯ Node.js ä»£ç åœ¨ [wxapp-login-server](https://github.com/chunpu/wxapp-login-server)
